<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>干瞪眼 计分器</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        h1, h2 {
            text-align: center;
            color: #444;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .players, .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        #player-names {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #e9ecef;
        }
        input[type="text"] {
            width: 90%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .score-cell {
            min-width: 100px;
        }
        .score-cell input, .round-multiplier-input, .winner-select {
            width: 80px;
            padding: 5px;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .score-display {
            font-weight: bold;
            margin-top: 5px;
        }
        .score-cell input:disabled {
            background-color: #eee;
        }
        .chart-container {
            position: relative; 
            height:50vh; 
            width:100%;
            max-width: 900px;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>干瞪眼 计分器</h1>

        <div class="players">
            <label for="numPlayers">玩家人数:</label>
            <input type="number" id="numPlayers" value="4" min="2" max="8" onchange="setupPlayers()">
        </div>

        <div id="player-names"></div>

        <h2>分数记录</h2>
        <table id="score-table">
            <thead>
                <tr>
                    <!-- Headers will be generated by JS -->
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div class="controls">
            <button onclick="addRound()">添加回合</button>
        </div>

        <h2>统计汇总</h2>
        <table id="summary-table">
            <thead>
                <tr>
                    <!-- Headers will be generated by JS -->
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <h2>下次再瞪，一雪前耻</h2>
        <div class="chart-container">
            <canvas id="scoreChart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let numPlayers = 4;
        let playerNames = [];
        let scoreChart;

        function setupPlayers() {
            numPlayers = parseInt(document.getElementById('numPlayers').value);
            const playerNamesDiv = document.getElementById('player-names');
            playerNamesDiv.innerHTML = '';
            for (let i = 0; i < numPlayers; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `玩家 ${i + 1}`;
                input.id = `player-name-${i}`;
                input.oninput = updateTableHeaders;
                playerNamesDiv.appendChild(input);
            }
            updateTableHeaders();
            clearRounds();
            addRound();
        }

        function updateTableHeaders() {
            const scoreTableHead = document.querySelector('#score-table thead tr');
            const summaryTableHead = document.querySelector('#summary-table thead tr');
            
            playerNames = [];
            for (let i = 0; i < numPlayers; i++) {
                const playerNameInput = document.getElementById(`player-name-${i}`);
                const playerName = (playerNameInput ? playerNameInput.value.trim() : '') || `玩家 ${i + 1}`;
                playerNames.push(playerName);
            }

            scoreTableHead.innerHTML = '<th>回合</th><th>倍数牌张数</th>';
            summaryTableHead.innerHTML = '<th>统计</th>';

            playerNames.forEach(name => {
                const thScore = document.createElement('th');
                thScore.textContent = name;
                thScore.classList.add('score-cell');
                scoreTableHead.appendChild(thScore);

                const thSummary = document.createElement('th');
                thSummary.textContent = name;
                summaryTableHead.appendChild(thSummary);
            });
            
            scoreTableHead.innerHTML += '<th>胜利者</th>';

            document.querySelectorAll('.winner-select').forEach(select => {
                const currentWinner = select.value;
                repopulateWinnerSelect(select);
                select.value = currentWinner;
                updateRoundData(select.closest('tr'));
            });

            calculateSummary();
        }
        
        function clearRounds() {
            const scoreTableBody = document.querySelector('#score-table tbody');
            scoreTableBody.innerHTML = '';
            if(scoreChart) {
                scoreChart.destroy();
            }
        }

        function repopulateWinnerSelect(selectElement) {
            selectElement.innerHTML = '';
            playerNames.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = name;
                selectElement.appendChild(option);
            });
        }

        function addRound() {
            const scoreTableBody = document.querySelector('#score-table tbody');
            const roundNum = scoreTableBody.rows.length + 1;
            const newRow = scoreTableBody.insertRow();
            newRow.id = `round-${roundNum}`;
            
            newRow.insertCell().textContent = roundNum;

            const multiplierCell = newRow.insertCell();
            const multiplierInput = document.createElement('input');
            multiplierInput.type = 'number';
            multiplierInput.title = '倍数牌张数';
            multiplierInput.value = '0';
            multiplierInput.min = '0';
            multiplierInput.classList.add('round-multiplier-input');
            multiplierInput.oninput = () => updateRoundData(newRow);
            multiplierCell.appendChild(multiplierInput);

            for (let i = 0; i < numPlayers; i++) {
                const cell = newRow.insertCell();
                cell.classList.add('score-cell');
                
                const remainingInput = document.createElement('input');
                remainingInput.type = 'number';
                remainingInput.placeholder = '剩余牌数';
                remainingInput.title = '剩余牌数';
                remainingInput.value = '0';
                remainingInput.min = '0';
                remainingInput.oninput = () => updateRoundData(newRow);
                
                const scoreDisplay = document.createElement('div');
                scoreDisplay.textContent = '分数: 0';
                scoreDisplay.classList.add('score-display');

                cell.appendChild(remainingInput);
                cell.appendChild(scoreDisplay);
            }

            const winnerCell = newRow.insertCell();
            const winnerSelect = document.createElement('select');
            winnerSelect.classList.add('winner-select');
            repopulateWinnerSelect(winnerSelect);
            winnerSelect.onchange = () => updateRoundData(newRow);
            winnerCell.appendChild(winnerSelect);
            
            updateRoundData(newRow);
        }

        function updateRoundData(roundRow) {
            if (!roundRow) return;
            const multiplier = roundRow.querySelector('.round-multiplier-input').valueAsNumber || 0;
            const winnerIndex = parseInt(roundRow.querySelector('.winner-select').value);

            let losersTotalScore = 0;
            const scoreCells = roundRow.querySelectorAll('.score-cell');

            scoreCells.forEach((cell, i) => {
                const remainingInput = cell.querySelector('input');
                const scoreDisplay = cell.querySelector('.score-display');

                if (i === winnerIndex) {
                    remainingInput.value = 0;
                    remainingInput.disabled = true;
                } else {
                    remainingInput.disabled = false;
                    const remainingCards = remainingInput.valueAsNumber || 0;
                    const score = -Math.abs(remainingCards * Math.pow(2, multiplier));
                    losersTotalScore += score;
                    scoreDisplay.textContent = `分数: ${score}`;
                }
            });

            if (scoreCells.length > winnerIndex && scoreCells[winnerIndex]) {
                const winnerScoreDisplay = scoreCells[winnerIndex].querySelector('.score-display');
                const winnerScore = -losersTotalScore;
                winnerScoreDisplay.textContent = `分数: ${winnerScore}`;
            }
            
            calculateSummary();
        }

        function calculateSummary() {
            const summaryBody = document.querySelector('#summary-table tbody');
            const scoreRows = document.querySelectorAll('#score-table tbody tr');
            const totalScores = Array(numPlayers).fill(0);
            const wins = Array(numPlayers).fill(0);

            scoreRows.forEach(row => {
                const winnerIndex = parseInt(row.querySelector('.winner-select').value);
                if (winnerIndex >= 0 && winnerIndex < wins.length) {
                    wins[winnerIndex]++;
                }

                row.querySelectorAll('.score-cell').forEach((cell, i) => {
                    const scoreDisplay = cell.querySelector('.score-display');
                    const scoreText = scoreDisplay.textContent.replace('分数: ', '');
                    const score = parseInt(scoreText) || 0;
                    
                    if (i < totalScores.length) {
                        totalScores[i] += score;
                    }
                });
            });

            summaryBody.innerHTML = '';
            const totalRow = summaryBody.insertRow();
            totalRow.innerHTML = '<td>总分</td>';
            totalScores.forEach(score => {
                const cell = totalRow.insertCell();
                cell.textContent = score;
            });

            const winsRow = summaryBody.insertRow();
            winsRow.innerHTML = '<td>胜利次数</td>';
            wins.forEach(winCount => {
                const cell = winsRow.insertCell();
                cell.textContent = winCount;
            });

            updateChart();
        }

        function updateChart() {
            const scoreRows = document.querySelectorAll('#score-table tbody tr');
            if (scoreRows.length === 0) return;

            const numRounds = scoreRows.length;
            const labels = Array.from({length: numRounds}, (_, i) => `回合 ${i + 1}`);

            const cumulativeScores = Array(numPlayers).fill(null).map(() => Array(numRounds).fill(0));

            scoreRows.forEach((row, roundIndex) => {
                row.querySelectorAll('.score-cell').forEach((cell, playerIndex) => {
                    if (playerIndex >= numPlayers) return; 
                    const scoreDisplay = cell.querySelector('.score-display');
                    const scoreText = scoreDisplay.textContent.replace('分数: ', '');
                    const score = parseInt(scoreText) || 0;
                    
                    const prevCumulativeScore = roundIndex > 0 ? cumulativeScores[playerIndex][roundIndex - 1] : 0;
                    cumulativeScores[playerIndex][roundIndex] = prevCumulativeScore + score;
                });
            });

            const datasets = playerNames.map((name, playerIndex) => {
                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#77DD77'];
                return {
                    label: name,
                    data: cumulativeScores[playerIndex],
                    borderColor: colors[playerIndex % colors.length],
                    tension: 0.1,
                    fill: false
                };
            });

            const ctx = document.getElementById('scoreChart').getContext('2d');
            if (scoreChart) {
                scoreChart.destroy();
            }
            scoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '累积总分'
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: '回合'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false, // Set to false as we have a main H2 title
                        }
                    }
                }
            });
        }

        // Initial setup
        window.onload = () => {
            document.getElementById('numPlayers').value = 4;
            setupPlayers();
        };

    </script>
</body>
</html>